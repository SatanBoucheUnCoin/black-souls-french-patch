name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-assets:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      tag: ${{ steps.version.outputs.TAG }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Generate Game.rgss3a
        run: |
          mkdir -p /tmp/patch-build
          cp -r Data /tmp/patch-build/
          cp -r Graphics /tmp/patch-build/
          cp -r Audio /tmp/patch-build/
          cp -r Fonts /tmp/patch-build/

          cd /tmp/patch-build
          python $GITHUB_WORKSPACE/rgss_tool.py pack . Game.rgss3a 3

          cp Game.rgss3a $GITHUB_WORKSPACE/
          ls -lh $GITHUB_WORKSPACE/Game.rgss3a

      - name: Prepare Linux installer
        run: |
          sed -i 's/VERSION="[0-9.]*"/VERSION="${{ steps.version.outputs.VERSION }}"/' build/linux/install.sh
          cp Game.rgss3a build/linux/
          cp steam_api.dll build/linux/
          chmod +x build/linux/install.sh

          # Copier les fichiers audio traduits pour Linux
          mkdir -p build/linux/Audio/BGS build/linux/Audio/SE
          cp Audio/BGS/Feu.ogg Audio/BGS/Vent.ogg Audio/BGS/T√©n√®bres.ogg build/linux/Audio/BGS/
          cp Audio/SE/Feu*.ogg Audio/SE/Vent*.ogg Audio/SE/Eau*.ogg build/linux/Audio/SE/
          cp Audio/SE/Glace*.ogg Audio/SE/Tonnerre*.ogg Audio/SE/Soin*.ogg build/linux/Audio/SE/
          cp Audio/SE/Attaque*.ogg Audio/SE/T√©n√®bres*.ogg build/linux/Audio/SE/

      - name: Upload Game.rgss3a
        uses: actions/upload-artifact@v4
        with:
          name: game-rgss3a
          path: Game.rgss3a

      - name: Upload Linux installer
        uses: actions/upload-artifact@v4
        with:
          name: linux-installer
          path: |
            build/linux/install.sh
            build/linux/steam_api.dll
            build/linux/Audio/

  build-windows:
    runs-on: windows-latest
    needs: build-assets

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Game.rgss3a
        uses: actions/download-artifact@v4
        with:
          name: game-rgss3a
          path: .

      - name: Update version in installer
        shell: pwsh
        run: |
          $content = Get-Content build/windows/installer.iss -Raw
          $content = $content -replace '#define MyAppVersion "[0-9.]+"', '#define MyAppVersion "${{ needs.build-assets.outputs.version }}"'
          Set-Content build/windows/installer.iss $content

      - name: Build Windows installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.4
        with:
          path: build/windows/installer.iss

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: dist/*.exe

  release:
    runs-on: ubuntu-latest
    needs: [build-assets, build-windows]

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          ls -laR artifacts/

          # Windows
          mv artifacts/windows-installer/*.exe .

          # Linux - cr√©er un ZIP avec tout dedans
          mkdir -p linux-package
          mv artifacts/game-rgss3a/Game.rgss3a linux-package/
          mv artifacts/linux-installer/install.sh linux-package/
          mv artifacts/linux-installer/steam_api.dll linux-package/
          mv artifacts/linux-installer/Audio linux-package/
          chmod +x linux-package/install.sh

          cd linux-package
          zip -r ../BlackSouls_PatchFR_v${{ needs.build-assets.outputs.version }}_Linux.zip .
          cd ..

          # ZIP Manuel (sans install.sh)
          mkdir -p manual-package
          cp linux-package/Game.rgss3a manual-package/
          cp linux-package/steam_api.dll manual-package/
          cp -r linux-package/Audio manual-package/
          cd manual-package
          zip -r ../BlackSouls_PatchFR_v${{ needs.build-assets.outputs.version }}_Manual.zip .
          cd ..

          ls -lh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Black Souls - Patch Fran√ßais ${{ needs.build-assets.outputs.tag }}"
          body: |
            ## üéÆ Patch Fran√ßais pour BLACK SOULS

            ### Installation automatique (recommand√©e)

            **Windows :**
            1. T√©l√©chargez `BlackSouls_PatchFR_v${{ needs.build-assets.outputs.version }}.exe`
            2. Lancez l'installateur
            3. Le jeu sera d√©tect√© automatiquement

            **Linux / Steam Deck :**
            1. T√©l√©chargez `BlackSouls_PatchFR_v${{ needs.build-assets.outputs.version }}_Linux.zip`
            2. Extrayez le ZIP
            3. Lancez : `chmod +x install.sh && ./install.sh`

            ### Installation manuelle

            1. T√©l√©chargez `BlackSouls_PatchFR_v${{ needs.build-assets.outputs.version }}_Manual.zip`
            2. Allez dans le dossier du jeu (`steamapps/common/BLACK SOULS/`)
            3. Renommez l'ancien `Game.rgss3a` en `Game.rgss3a.backup`
            4. Extrayez le contenu du ZIP dans le dossier du jeu

            ---
            Consultez le [README](https://github.com/${{ github.repository }}) pour plus de d√©tails.
          files: |
            *.exe
            *_Linux.zip
            *_Manual.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
